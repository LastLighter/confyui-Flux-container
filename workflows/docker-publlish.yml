<antArtifact identifier="docker-publish-workflow" type="application/vnd.ant.code" language="yaml" title="GitHub Actions Workflow for Docker Publishing">
name: Docker Build and Publish

on:
push:
branches: [ main, master ]
workflow_dispatch:  # 允许手动触发

jobs:
build-and-push:
runs-on: ubuntu-latest
# 如果镜像很大，可能需要增加超时时间
timeout-minutes: 420  # 设置较长的超时时间

steps:
  - name: Checkout repository
    uses: actions/checkout@v3
  
  - name: Set up Docker Buildx
    uses: docker/setup-buildx-action@v2
  
  - name: Log in to Docker Hub
    uses: docker/login-action@v2
    with:
      username: ${{ secrets.DOCKER_USERNAME }}
      password: ${{ secrets.DOCKER_PASSWORD }}
  
  # 如果你要推送到GitHub Container Registry，使用下面这段代替上面的登录
  # - name: Log in to GitHub Container Registry
  #   uses: docker/login-action@v2
  #   with:
  #     registry: ghcr.io
  #     username: ${{ github.actor }}
  #     password: ${{ secrets.GITHUB_TOKEN }}
  
  - name: Build and push Docker image
    uses: docker/build-push-action@v4
    with:
      context: .
      push: true
      tags: |
        lastlighter/comfyui-flux:latest
        lastlighter/comfyui-flux:${{ github.sha }}
      # 如果需要自定义Dockerfile路径
      # file: ./path/to/your/Dockerfile
      # 启用缓存以加速构建过程
      cache-from: type=gha
      cache-to: type=gha,mode=max
      # 对于大型镜像，可能需要以下参数
      platforms: linux/amd64
      # 添加构建参数，如果有需要的话
      # build-args: |
      #   ARG1=value1
      #   ARG2=value2
</antArtifact>